(function () {
  const STATE_KEY = "MICTOOLBOXAPPSTATE";
  const DEFAULT_STATE = {
    bodyClass: [],
    fontSize: 1,
    imagesTitle: false,
    keyboardRoot: false,
    initFontSize: false,
  };

  const STRINGS = {
    "en": {
      openLabel: "Accessibility",
      closeLabel: "Close menu",
      disableSection: "Accessibility assistance",
      keyboardNav: "Keyboard navigation",
      blockAnimations: "Block animations",
      resetAll: "Reset settings",
      contrast: "Contrast",
      mono: "Monochrome",
      soft: "Soft contrast",
      hard: "Hard contrast",
      text: "Text",
      textUp: "Increase text",
      textDown: "Decrease text",
      readableFont: "Readable font",
      content: "Content highlighting",
      underlineLinks: "Underline links",
      underlineHeaders: "Underline headers",
      imageTitles: "Show image titles",
      zoom: "Zoom & cursor",
      zoomUp: "Zoom page",
      cursorWhite: "Large white cursor",
      cursorBlack: "Large black cursor",
      statement: "Accessibility statement",
      contact: "Report a problem",
      percent: (value) => `${Math.round(value * 100)}%`,
    },
    "he-IL": {
      openLabel: "נגישות",
      closeLabel: "סגור תפריט",
      disableSection: "סיוע נגישות",
      keyboardNav: "ניווט במקלדת",
      blockAnimations: "חסימת אנימציות",
      resetAll: "איפוס הגדרות",
      contrast: "ניגודיות",
      mono: "גווני אפור",
      soft: "ניגודיות רכה",
      hard: "ניגודיות גבוהה",
      text: "טקסט",
      textUp: "הגדלת טקסט",
      textDown: "הקטנת טקסט",
      readableFont: "פונט קריא",
      content: "הדגשת תוכן",
      underlineLinks: "קו תחתון לקישורים",
      underlineHeaders: "קו תחתון לכותרות",
      imageTitles: "הצגת כותרות תמונות",
      zoom: "זום וסמן",
      zoomUp: "הגדלת עמוד",
      cursorWhite: "סמן לבן גדול",
      cursorBlack: "סמן שחור גדול",
      statement: "הצהרת נגישות",
      contact: "דיווח על בעיה",
      percent: (value) => `${Math.round(value * 100)}%`,
    },
    "ru-RU": {
      openLabel: "Доступность",
      closeLabel: "Закрыть меню",
      disableSection: "Помощь по доступности",
      keyboardNav: "Навигация с клавиатуры",
      blockAnimations: "Блокировать анимации",
      resetAll: "Сбросить настройки",
      contrast: "Контраст",
      mono: "Монохром",
      soft: "Мягкий контраст",
      hard: "Высокий контраст",
      text: "Текст",
      textUp: "Увеличить текст",
      textDown: "Уменьшить текст",
      readableFont: "Читаемый шрифт",
      content: "Подсветка контента",
      underlineLinks: "Подчеркнуть ссылки",
      underlineHeaders: "Подчеркнуть заголовки",
      imageTitles: "Показывать подписи к изображениям",
      zoom: "Зум и курсор",
      zoomUp: "Увеличить страницу",
      cursorWhite: "Белый крупный курсор",
      cursorBlack: "Черный крупный курсор",
      statement: "Заявление о доступности",
      contact: "Сообщить о проблеме",
      percent: (value) => `${Math.round(value * 100)}%`,
    },
  };

  function createBaseSvgCursor(color) {
    const stroke = color === "white" ? "#ffffff" : "#111111";
    const fill = color === "white" ? "#ffffff" : "#111111";
    const svg =
      `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"64\" height=\"64\" viewBox=\"0 0 64 64\">` +
      `<path fill=\"${fill}\" stroke=\"${stroke}\" stroke-width=\"2\" d=\"M6 2l20 32-8 2 3 12-6 2-3-12-8 2z\"/></svg>`;
    return `url('data:image/svg+xml;utf8,${svg}') 0 0, auto`;
  }

  class MicAccessTool {
    constructor(options = {}) {
      this.options = {
        forceLang: "",
        buttonPosition: "left",
        link: "#",
        contact: "#",
        showLink: true,
        showContact: true,
        ...options,
      };
      this.state = this.loadState();
      this.langKey = this.pickLanguage();
      this.strings = STRINGS[this.langKey] || STRINGS["en"];
      this.textElements = new Set();
      if (typeof window === "undefined" || typeof document === "undefined") return;
      this.injectStyles();
      this.injectMarkup();
      this.initialApp();
      this.bindEvents();
    }

    pickLanguage() {
      if (this.options.forceLang && STRINGS[this.options.forceLang]) {
        return this.options.forceLang;
      }
      const htmlLang = (document.documentElement.getAttribute("lang") || "").trim();
      if (htmlLang && STRINGS[htmlLang]) return htmlLang;
      return "en";
    }

    loadState() {
      try {
        const stored = window.localStorage.getItem(STATE_KEY);
        if (stored) {
          return { ...DEFAULT_STATE, ...JSON.parse(stored) };
        }
      } catch (err) {
        console.warn("Accessibility tool: failed to load state", err);
      }
      return { ...DEFAULT_STATE };
    }

    saveState() {
      try {
        window.localStorage.setItem(STATE_KEY, JSON.stringify(this.state));
      } catch (err) {
        console.warn("Accessibility tool: failed to save state", err);
      }
    }

    updateState(partial) {
      this.state = { ...this.state, ...partial };
      this.saveState();
    }

    injectStyles() {
      const style = document.createElement("style");
      style.id = "mic-access-tool-style";
      style.innerHTML = `
      #mic-init-access-tool * { box-sizing: border-box; }
      #mic-init-access-tool { direction: ${this.langKey === "he-IL" ? "rtl" : "ltr"}; font-family: Arial, Helvetica, sans-serif; }
      #mic-access-tool-launcher { position: fixed; ${this.options.buttonPosition === "right" ? "right: 16px;" : "left: 16px;"} bottom: 16px; z-index: 2147483000; }
      #mic-access-tool-launcher button { background: #1f2937; color: #f8fafc; border: 2px solid #6366f1; padding: 10px 14px; border-radius: 999px; cursor: pointer; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.35); display: flex; gap: 8px; align-items: center; }
      #mic-access-tool-launcher button:hover, #mic-access-tool-launcher button:focus { background: #312e81; outline: none; }
      #mic-access-tool-launcher kbd { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); font-size: 12px; }
      #mic-access-tool-box { position: fixed; top: 0; ${this.options.buttonPosition === "right" ? "right" : "left"}: -360px; width: 340px; height: 100vh; background: #0b1224; color: #f8fafc; z-index: 2147483646; transition: transform 0.35s ease, box-shadow 0.35s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.35); display: flex; flex-direction: column; }
      #mic-access-tool-box.mic-open { transform: translateX(${this.options.buttonPosition === "right" ? "-360px" : "360px"}); }
      #mic-access-tool-box header { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: #111827; border-bottom: 1px solid rgba(255,255,255,0.08); }
      #mic-access-tool-box h2 { margin: 0; font-size: 18px; }
      #mic-access-tool-box button.mic-close { background: transparent; border: 1px solid rgba(255,255,255,0.25); color: #f8fafc; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
      #mic-access-tool-box .mic-panel { padding: 12px 16px; overflow-y: auto; flex: 1; }
      #mic-access-tool-box section { margin-bottom: 14px; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.02); }
      #mic-access-tool-box h3 { margin: 0 0 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.03em; color: #c7d2fe; }
      #mic-access-tool-box .mic-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
      #mic-access-tool-box .mic-grid.single { grid-template-columns: 1fr; }
      #mic-access-tool-box .mic-btn { border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.04); color: #f8fafc; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: 600; text-align: center; transition: background 0.2s ease, border-color 0.2s ease; }
      #mic-access-tool-box .mic-btn:hover, #mic-access-tool-box .mic-btn:focus { background: rgba(99,102,241,0.25); border-color: #818cf8; outline: none; }
      #mic-access-tool-box .mic-btn.active { background: #4338ca; border-color: #a5b4fc; }
      #mic-access-tool-box footer { padding: 12px 16px 16px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); }
      #mic-access-tool-box footer a { color: #c7d2fe; text-decoration: none; font-weight: 600; display: block; margin-bottom: 6px; }
      #mic-access-tool-box footer a:hover, #mic-access-tool-box footer a:focus { text-decoration: underline; }
      #mic-toolbox-fonts-indicator { font-weight: 700; text-align: center; padding: 6px 0; }
      .mic-toolbox-images-titles { display: block; font-size: 12px; color: #1f2937; background: #e5e7eb; padding: 4px 6px; margin-bottom: 4px; border-radius: 6px; }
      body.mic-toolbox-contrast-monochrome { filter: grayscale(1) !important; }
      body.mic-toolbox-contrast-soft *:not(img, video) { background: transparent !important; color: #000 !important; box-shadow: none !important; }
      body.mic-toolbox-contrast-hard { filter: invert(1) hue-rotate(180deg) !important; }
      body.mic-toolbox-disable-buttons-animations *, body.mic-toolbox-disable-buttons-animations *:before, body.mic-toolbox-disable-buttons-animations *:after { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
      body.mic-toolbox-disable-buttons-keyboard :focus { outline: 3px solid #6366f1 !important; outline-offset: 2px !important; }
      body.mic-toolbox-fonts-simple { font-family: Arial, Helvetica, sans-serif !important; }
      body.mic-toolbox-content-links a { text-decoration: underline !important; }
      body.mic-toolbox-content-headers h1, body.mic-toolbox-content-headers h2, body.mic-toolbox-content-headers h3, body.mic-toolbox-content-headers h4, body.mic-toolbox-content-headers h5, body.mic-toolbox-content-headers h6 { text-decoration: underline !important; }
      body.mic-toolbox-content-images img { outline: 2px dashed #9ca3af; outline-offset: 2px; }
      body.mic-toolbox-cursor-big-white { cursor: ${createBaseSvgCursor("white")}; }
      body.mic-toolbox-cursor-big-white a, body.mic-toolbox-cursor-big-white button { cursor: ${createBaseSvgCursor("white")}; }
      body.mic-toolbox-cursor-big-black { cursor: ${createBaseSvgCursor("black")}; }
      body.mic-toolbox-cursor-big-black a, body.mic-toolbox-cursor-big-black button { cursor: ${createBaseSvgCursor("black")}; }
      body.mic-toolbox-zoom-up { zoom: 1.4; transform: scale(1.0); transform-origin: top left; }
      @media (max-width: 768px) { #mic-access-tool-box { width: 100%; ${this.options.buttonPosition === "right" ? "right" : "left"}: -100%; } #mic-access-tool-box.mic-open { transform: translateX(${this.options.buttonPosition === "right" ? "-100%" : "100%"}); } }
      `;
      document.head.appendChild(style);
    }

    injectMarkup() {
      if (document.getElementById("mic-init-access-tool")) return;
      const wrapper = document.createElement("div");
      wrapper.id = "mic-init-access-tool";
      wrapper.innerHTML = `
        <div id="mic-access-tool-launcher" aria-live="polite">
          <button type="button" aria-label="${this.strings.openLabel}" id="mic-access-tool-open">
            <span>${this.strings.openLabel}</span>
            <kbd>CTRL + F2</kbd>
          </button>
        </div>
        <aside id="mic-access-tool-box" role="dialog" aria-modal="true" aria-labelledby="mic-access-tool-title">
          <header>
            <h2 id="mic-access-tool-title">${this.strings.openLabel}</h2>
            <button type="button" class="mic-close" id="mic-access-tool-close">${this.strings.closeLabel}</button>
          </header>
          <div class="mic-panel">
            <section>
              <h3>${this.strings.disableSection}</h3>
              <div class="mic-grid">
                <button id="mic-toolbox-disable-buttons-keyboard" class="mic-btn" type="button">${this.strings.keyboardNav}</button>
                <button id="mic-toolbox-disable-buttons-animations" class="mic-btn" type="button">${this.strings.blockAnimations}</button>
                <button id="mic-toolbox-disable-buttons-reset-all" class="mic-btn mic-reset" type="button">${this.strings.resetAll}</button>
              </div>
            </section>
            <section>
              <h3>${this.strings.contrast}</h3>
              <div class="mic-grid">
                <button id="mic-toolbox-contrast-monochrome" class="mic-btn" type="button">${this.strings.mono}</button>
                <button id="mic-toolbox-contrast-soft" class="mic-btn" type="button">${this.strings.soft}</button>
                <button id="mic-toolbox-contrast-hard" class="mic-btn" type="button">${this.strings.hard}</button>
              </div>
            </section>
            <section>
              <h3>${this.strings.text}</h3>
              <div class="mic-grid">
                <button id="mic-toolbox-fonts-up" class="mic-btn" type="button">${this.strings.textUp}</button>
                <button id="mic-toolbox-fonts-down" class="mic-btn" type="button">${this.strings.textDown}</button>
                <button id="mic-toolbox-fonts-simple" class="mic-btn" type="button">${this.strings.readableFont}</button>
                <div id="mic-toolbox-fonts-indicator" aria-live="polite">${this.strings.percent(this.state.fontSize)}</div>
              </div>
            </section>
            <section>
              <h3>${this.strings.content}</h3>
              <div class="mic-grid">
                <button id="mic-toolbox-content-links" class="mic-btn" type="button">${this.strings.underlineLinks}</button>
                <button id="mic-toolbox-content-headers" class="mic-btn" type="button">${this.strings.underlineHeaders}</button>
                <button id="mic-toolbox-content-images" class="mic-btn" type="button">${this.strings.imageTitles}</button>
              </div>
            </section>
            <section>
              <h3>${this.strings.zoom}</h3>
              <div class="mic-grid single">
                <button id="mic-toolbox-zoom-up" class="mic-btn" type="button">${this.strings.zoomUp}</button>
                <button id="mic-toolbox-cursor-big-white" class="mic-btn" type="button">${this.strings.cursorWhite}</button>
                <button id="mic-toolbox-cursor-big-black" class="mic-btn" type="button">${this.strings.cursorBlack}</button>
              </div>
            </section>
          </div>
          <footer>
            ${this.options.showLink && this.options.link ? `<a id="mic-toolbox-statement" href="${this.options.link}" target="_blank" rel="noopener noreferrer">${this.strings.statement}</a>` : ""}
            ${this.options.showContact && this.options.contact ? `<a id="mic-toolbox-contact" href="${this.options.contact}" target="_blank" rel="noopener noreferrer">${this.strings.contact}</a>` : ""}
          </footer>
        </aside>
      `;
      document.body.appendChild(wrapper);
    }

    initialApp() {
      this.applyBodyClasses(this.state.bodyClass || []);
      this.applyFontSize();
      if (this.state.imagesTitle) {
        this.applyImageTitles(true);
      }
      if (this.state.keyboardRoot) {
        this.applyKeyboardHelper(true);
      }
      this.syncButtonStates();
    }

    bindEvents() {
      const openBtn = document.getElementById("mic-access-tool-open");
      const closeBtn = document.getElementById("mic-access-tool-close");
      const box = document.getElementById("mic-access-tool-box");
      openBtn?.addEventListener("click", () => this.openDrawer());
      closeBtn?.addEventListener("click", () => this.closeDrawer());

      document.addEventListener("keydown", (event) => {
        if (event.key === "F2" && event.ctrlKey) {
          event.preventDefault();
          this.toggleDrawer();
        }
        if (event.key === "Escape" && this.isOpen()) {
          this.closeDrawer();
        }
      });

      box?.addEventListener("keydown", (event) => {
        if (event.key === "Tab" && this.isOpen()) {
          // simple focus trap to the close button
          const focusable = Array.from(box.querySelectorAll("button, [href], input, select, textarea"))
            .filter((el) => !el.hasAttribute("disabled"));
          if (focusable.length) {
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (event.shiftKey && document.activeElement === first) {
              event.preventDefault();
              last.focus();
            } else if (!event.shiftKey && document.activeElement === last) {
              event.preventDefault();
              first.focus();
            }
          }
        }
      });

      this.bindToggle("mic-toolbox-disable-buttons-keyboard", "mic-toolbox-disable-buttons-keyboard", true, (enabled) => {
        this.applyKeyboardHelper(enabled);
        this.updateState({ keyboardRoot: enabled });
      });

      this.bindToggle("mic-toolbox-disable-buttons-animations", "mic-toolbox-disable-buttons-animations", true);

      const resetBtn = document.getElementById("mic-toolbox-disable-buttons-reset-all");
      resetBtn?.addEventListener("click", () => {
        window.localStorage.removeItem(STATE_KEY);
        window.location.reload();
      });

      this.bindExclusiveGroup([
        { id: "mic-toolbox-contrast-monochrome", cls: "mic-toolbox-contrast-monochrome" },
        { id: "mic-toolbox-contrast-soft", cls: "mic-toolbox-contrast-soft" },
        { id: "mic-toolbox-contrast-hard", cls: "mic-toolbox-contrast-hard" },
      ]);

      const fontUp = document.getElementById("mic-toolbox-fonts-up");
      const fontDown = document.getElementById("mic-toolbox-fonts-down");
      fontUp?.addEventListener("click", () => {
        this.state.fontSize = Math.min(3, +(this.state.fontSize + 0.1).toFixed(2));
        this.applyFontSize();
        this.updateState({ fontSize: this.state.fontSize, initFontSize: true });
        this.updateFontIndicator();
      });
      fontDown?.addEventListener("click", () => {
        this.state.fontSize = Math.max(0.5, +(this.state.fontSize - 0.1).toFixed(2));
        this.applyFontSize();
        this.updateState({ fontSize: this.state.fontSize, initFontSize: true });
        this.updateFontIndicator();
      });

      this.bindToggle("mic-toolbox-fonts-simple", "mic-toolbox-fonts-simple", true);

      this.bindToggle("mic-toolbox-content-links", "mic-toolbox-content-links", true);
      this.bindToggle("mic-toolbox-content-headers", "mic-toolbox-content-headers", true);

      this.bindToggle("mic-toolbox-content-images", "mic-toolbox-content-images", true, (enabled) => {
        this.applyImageTitles(enabled);
        this.updateState({ imagesTitle: enabled });
      });

      this.bindToggle("mic-toolbox-zoom-up", "mic-toolbox-zoom-up", true);

      this.bindExclusiveGroup([
        { id: "mic-toolbox-cursor-big-white", cls: "mic-toolbox-cursor-big-white" },
        { id: "mic-toolbox-cursor-big-black", cls: "mic-toolbox-cursor-big-black" },
      ]);

      this.updateFontIndicator();
      this.syncButtonStates();
    }

    bindToggle(id, cls, persist = false, callback) {
      const button = document.getElementById(id);
      button?.addEventListener("click", () => {
        const enabled = !document.body.classList.contains(cls);
        document.body.classList.toggle(cls, enabled);
        button.classList.toggle("active", enabled);
        if (persist) {
          const newClasses = new Set(this.state.bodyClass || []);
          if (enabled) newClasses.add(cls);
          else newClasses.delete(cls);
          this.updateState({ bodyClass: Array.from(newClasses) });
        }
        if (callback) callback(enabled);
      });
    }

    bindExclusiveGroup(items) {
      items.forEach(({ id, cls }) => {
        const button = document.getElementById(id);
        button?.addEventListener("click", () => {
          const alreadyActive = document.body.classList.contains(cls);
          const newClasses = new Set(this.state.bodyClass || []);
          items.forEach(({ id: otherId, cls: otherCls }) => {
            document.body.classList.remove(otherCls);
            const otherBtn = document.getElementById(otherId);
            otherBtn?.classList.remove("active");
            newClasses.delete(otherCls);
          });
          if (!alreadyActive) {
            document.body.classList.add(cls);
            button.classList.add("active");
            newClasses.add(cls);
          }
          this.updateState({ bodyClass: Array.from(newClasses) });
        });
      });
    }

    applyBodyClasses(classList) {
      (classList || []).forEach((cls) => {
        document.body.classList.add(cls);
        const button = document.getElementById(cls);
        if (button) button.classList.add("active");
      });
      this.syncButtonStates();
    }

    applyFontSize() {
      const targets = document.querySelectorAll(
        "p, span, li, a, button, input, textarea, label, h1, h2, h3, h4, h5, h6"
      );
      targets.forEach((el) => {
        if (!el.dataset.micToolboxBaseFont) {
          const size = window.getComputedStyle(el).fontSize;
          el.dataset.micToolboxBaseFont = parseFloat(size);
        }
        const base = parseFloat(el.dataset.micToolboxBaseFont);
        const newSize = base * this.state.fontSize;
        if (this.state.fontSize === 1) {
          el.style.fontSize = "";
        } else {
          el.style.fontSize = `${newSize}px`;
        }
        this.textElements.add(el);
      });
    }

    updateFontIndicator() {
      const indicator = document.getElementById("mic-toolbox-fonts-indicator");
      if (indicator) indicator.textContent = this.strings.percent(this.state.fontSize);
    }

    applyImageTitles(enabled) {
      const images = document.querySelectorAll("img");
      images.forEach((img) => {
        if (enabled) {
          if (img.dataset.micHasTitle) return;
          const span = document.createElement("span");
          span.className = "mic-toolbox-images-titles";
          span.textContent = img.getAttribute("alt") || "image without text";
          img.parentElement?.insertBefore(span, img);
          img.dataset.micHasTitle = "true";
        } else if (img.dataset.micHasTitle) {
          const prev = img.previousElementSibling;
          if (prev && prev.classList.contains("mic-toolbox-images-titles")) {
            prev.remove();
          }
          delete img.dataset.micHasTitle;
        }
      });
    }

    applyKeyboardHelper(enabled) {
      const targets = document.querySelectorAll("a, button, input, select, textarea, [tabindex]");
      targets.forEach((el) => {
        if (enabled) {
          if (!el.hasAttribute("tabindex")) {
            el.setAttribute("tabindex", "0");
            el.dataset.micAddedTabindex = "true";
          }
        } else if (el.dataset.micAddedTabindex) {
          el.removeAttribute("tabindex");
          delete el.dataset.micAddedTabindex;
        }
      });
    }

    syncButtonStates() {
      (this.state.bodyClass || []).forEach((cls) => {
        const button = document.getElementById(cls);
        if (button) button.classList.add("active");
      });
      if (this.state.imagesTitle) {
        document.getElementById("mic-toolbox-content-images")?.classList.add("active");
      }
      if (this.state.keyboardRoot) {
        document.getElementById("mic-toolbox-disable-buttons-keyboard")?.classList.add("active");
      }
    }

    isOpen() {
      return document.getElementById("mic-access-tool-box")?.classList.contains("mic-open");
    }

    openDrawer() {
      const box = document.getElementById("mic-access-tool-box");
      const closeBtn = document.getElementById("mic-access-tool-close");
      if (!box) return;
      box.classList.add("mic-open");
      closeBtn?.focus();
    }

    closeDrawer() {
      const box = document.getElementById("mic-access-tool-box");
      if (!box) return;
      box.classList.remove("mic-open");
      document.getElementById("mic-access-tool-open")?.focus();
    }

    toggleDrawer() {
      if (this.isOpen()) this.closeDrawer();
      else this.openDrawer();
    }
  }

  window.MicAccessTool = MicAccessTool;
})();
